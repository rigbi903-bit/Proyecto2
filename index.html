<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GG Master Builder - Atomic Engine V9.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #e2e8f0; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .menu-child { 
            margin-left: 1rem; 
            border-left: 2px dashed #334155; 
            padding-left: 0.75rem; 
            position: relative; 
            margin-top: 0.5rem; 
            margin-bottom: 0.5rem; 
        }
        .menu-child::before { 
            content: ""; 
            position: absolute; 
            left: 0; 
            top: 1.2rem; 
            width: 0.6rem; 
            border-top: 2px dashed #334155; 
        }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .collapsed { display: none !important; }
        .rotate-icon { transform: rotate(180deg); }

        .toolbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        @keyframes toast {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        .toast-animate { animation: toast 0.3s ease-out forwards; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <input type="file" id="backup-input" class="hidden" accept=".txt" onchange="importBackup(event)">

    <header class="h-16 px-4 bg-slate-900 border-b border-slate-800 flex justify-between items-center shrink-0 z-40 shadow-xl">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 p-1.5 rounded-lg shadow-lg">
                <i data-lucide="shield-check" class="w-4 h-4 text-white"></i>
            </div>
            <h1 class="text-[10px] font-black tracking-tighter uppercase italic leading-none">GG BUILDER <span class="text-indigo-400">V9.7</span></h1>
        </div>
        <div class="flex gap-2">
            <button onclick="exportBackup()" title="Guardar" class="p-2 bg-slate-800 rounded-lg text-emerald-400 hover:bg-emerald-500/10 transition-colors">
                <i data-lucide="save" class="w-4 h-4"></i>
            </button>
            <button onclick="document.getElementById('backup-input').click()" title="Cargar" class="p-2 bg-slate-800 rounded-lg text-amber-400 hover:bg-amber-500/10 transition-colors">
                <i data-lucide="folder-up" class="w-4 h-4"></i>
            </button>
            <button onclick="clearAll()" class="p-2 bg-slate-800 rounded-lg text-slate-400 hover:text-rose-400 transition-colors">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
            <button onclick="generateLua()" class="flex items-center gap-1.5 px-3 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-[10px] font-black shadow-lg text-white">
                <i data-lucide="code-2" class="w-3 h-3"></i> GENERAR LUA
            </button>
        </div>
    </header>

    <nav class="bg-slate-900/50 border-b border-slate-800 p-2 overflow-x-auto flex gap-2 shrink-0 no-scrollbar">
        <button onclick="toggleSection('struct')" class="shrink-0 px-3 py-1.5 rounded-full bg-indigo-500/10 border border-indigo-500/30 text-indigo-400 text-[9px] font-bold uppercase">Estructura</button>
        <button onclick="toggleSection('memory')" class="shrink-0 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/30 text-emerald-400 text-[9px] font-bold uppercase">Memoria</button>
        <button onclick="toggleSection('offset')" class="shrink-0 px-3 py-1.5 rounded-full bg-pink-500/10 border border-pink-500/30 text-pink-400 text-[9px] font-bold uppercase">Offsets</button>
        <button onclick="toggleSection('control')" class="shrink-0 px-3 py-1.5 rounded-full bg-orange-500/10 border border-orange-500/30 text-orange-400 text-[9px] font-bold uppercase">Control</button>
    </nav>

    <div id="toolbox-panel" class="bg-slate-900 border-b border-slate-800 hidden max-h-[45vh] overflow-y-auto p-4 z-30 shadow-2xl">
        <div id="toolbox-content" class="toolbox-grid"></div>
    </div>

    <main class="flex-1 bg-[#020617] p-4 overflow-y-auto relative">
        <div id="workspace" class="max-w-full mx-auto space-y-3 pb-24"></div>
        <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-20 text-center px-6">
            <i data-lucide="terminal" class="w-16 h-16 mb-4 text-indigo-500"></i>
            <p class="text-xs font-black uppercase tracking-widest text-white">Añade elementos para empezar</p>
        </div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black/95 backdrop-blur-md hidden flex-col z-50">
        <div class="flex justify-between items-center p-4 border-b border-slate-800 bg-slate-900">
            <span class="text-[10px] font-black text-indigo-400 tracking-widest uppercase italic">SCRIPT LUA</span>
            <button onclick="closeModal()" class="text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div class="flex-1 overflow-auto p-4 bg-black">
            <pre id="code-box" class="text-[10px] text-indigo-300 mono whitespace-pre-wrap"></pre>
        </div>
        <div class="p-4 bg-slate-900 flex gap-2">
            <button onclick="copyCode()" class="flex-1 bg-slate-800 py-4 rounded-xl text-[10px] font-black flex items-center justify-center gap-2 text-white hover:bg-slate-700 transition-colors">
                <i data-lucide="copy" class="w-4 h-4"></i> COPIAR
            </button>
            <button onclick="downloadLua()" class="flex-1 bg-indigo-600 py-4 rounded-xl text-[10px] font-black flex items-center justify-center gap-2 text-white hover:bg-indigo-500 transition-colors">
                <i data-lucide="download" class="w-4 h-4"></i> DESCARGAR
            </button>
        </div>
    </div>

    <script>
        const TYPES = { STRUCT: 'S', OFFSET_MOD: 'O', MENU_ACT: 'M' };
        
        const GG_TYPES = [
            { n: 'Dword', v: 'gg.TYPE_DWORD' }, 
            { n: 'Float', v: 'gg.TYPE_FLOAT' }, 
            { n: 'Double', v: 'gg.TYPE_DOUBLE' }, 
            { n: 'Word', v: 'gg.TYPE_WORD' }, 
            { n: 'Byte', v: 'gg.TYPE_BYTE' }, 
            { n: 'Qword', v: 'gg.TYPE_QWORD' }, 
            { n: 'A', v: 'gg.TYPE_AUTO' }
        ];

        const PROMPT_MODES = [{ n: 'Busqueda', v: 'SEARCH' }, { n: 'Editar', v: 'EDIT' }];

        const GG_REGIONS = [
            { n: 'Jh', v: 'gg.REGION_JAVA_HEAP' }, 
            { n: 'Ch', v: 'gg.REGION_C_HEAP' }, 
            { n: 'Ca', v: 'gg.REGION_C_ALLOC' }, 
            { n: 'Cd', v: 'gg.REGION_C_DATA' }, 
            { n: 'Cb', v: 'gg.REGION_C_BSS' }, 
            { n: 'Ps', v: 'gg.REGION_PPSSPP' }, 
            { n: 'A', v: 'gg.REGION_ANONYMOUS' }, 
            { n: 'O', v: 'gg.REGION_OTHER' }
        ];

        const GG_OPS = [{ n: '(+)', v: '+' }, { n: '(-)', v: '-' }];

        const blocksDef = [
            { id: 'menu_main', group: 'struct', type: TYPES.STRUCT, name: 'Menú Principal', color: 'bg-purple-600', icon: 'layout', params: ['Título'], def: ['MOD MENU'] },
            { id: 'menu_btn', group: 'struct', type: TYPES.STRUCT, name: 'Añadir Botón', color: 'bg-indigo-500', icon: 'square-plus', params: ['Nombre'], def: ['Función'] },
            { id: 'search', group: 'memory', name: 'Buscar', color: 'bg-blue-600', icon: 'search', params: ['Valor', 'Tipo'], def: ['0', 'gg.TYPE_DWORD'] },
            { id: 'edit', group: 'memory', name: 'Editar', color: 'bg-blue-500', icon: 'pencil', params: ['Valor', 'Tipo'], def: ['0', 'gg.TYPE_DWORD'] },
            { id: 'refine', group: 'memory', name: 'Refinar', color: 'bg-sky-500', icon: 'filter', params: ['Valor', 'Tipo'], def: ['0', 'gg.TYPE_DWORD'] },
            { id: 'limit', group: 'memory', name: 'Limitar', color: 'bg-cyan-600', icon: 'list-ordered', params: ['Cant'], def: ['0'] },
            { id: 'region', group: 'memory', name: 'Rango Memoria', color: 'bg-teal-600', icon: 'database', params: ['Región'], def: ['gg.REGION_OTHER'] },
            { id: 'clear', group: 'memory', name: 'Limpiar', color: 'bg-rose-600', icon: 'eraser', params: [], def: [] },
            { id: 'off_base', group: 'offset', type: TYPES.OFFSET_MOD, name: 'Base Offset', color: 'bg-pink-600', icon: 'anchor', params: [], def: [] },
            { id: 'off_load', group: 'offset', type: TYPES.OFFSET_MOD, name: 'Cargar Offset', color: 'bg-emerald-600', icon: 'list-plus', params: ['Op', 'Hex', 'Tipo'], def: ['+', '0', 'gg.TYPE_DWORD'] },
            { id: 'off_edit', group: 'offset', type: TYPES.OFFSET_MOD, name: 'Editar Offset', color: 'bg-rose-600', icon: 'pencil-line', params: ['Op', 'Hex', 'Valor', 'Tipo'], def: ['+', '0', '0', 'gg.TYPE_DWORD'] },
            { id: 'dual_prompt', group: 'control', name: 'Prompt (Dual)', color: 'bg-fuchsia-600', icon: 'keyboard', params: ['Descripcion', 'Modo', 'Tipo'], def: ['Agrega un valor', 'SEARCH', 'gg.TYPE_DWORD'] },
            { id: 'sleep', group: 'control', name: 'Espera', color: 'bg-slate-500', icon: 'clock', params: ['ms'], def: ['500'] },
            { id: 'alert', group: 'control', name: 'Alerta', color: 'bg-yellow-600', icon: 'bell', params: ['Msg'], def: ['Hecho'] },
            { id: 'toast', group: 'control', name: 'Toast', color: 'bg-orange-500', icon: 'zap', params: ['Msg'], def: ['Hecho'] },
            { id: 'hide', group: 'control', name: 'Ocultar GG', color: 'bg-gray-600', icon: 'eye-off', params: [], def: [] },
            { id: 'pause', group: 'control', name: 'Pausar', color: 'bg-red-600', icon: 'pause', params: [], def: [] },
            { id: 'resume', group: 'control', name: 'Reanudar', color: 'bg-green-600', icon: 'play', params: [], def: [] }
        ];

        let activeBlocks = [];
        let collapsedStates = {};
        let currentSection = null;

        function toggleSection(section) {
            const panel = document.getElementById('toolbox-panel');
            const content = document.getElementById('toolbox-content');
            if (currentSection === section) { panel.classList.add('hidden'); currentSection = null; return; }
            content.innerHTML = '';
            blocksDef.filter(b => b.group === section).forEach(b => {
                const ctx = (b.type === TYPES.STRUCT) ? b.type : TYPES.MENU_ACT;
                const btn = document.createElement('button');
                btn.className = `${b.color} flex items-center gap-2 p-3 rounded-xl text-left border-b-2 border-black/30 shadow-md transition-all active:scale-95 text-white`;
                btn.onclick = () => { addBlock(b, ctx); panel.classList.add('hidden'); currentSection = null; };
                btn.innerHTML = `<i data-lucide="${b.icon}" class="w-3.5 h-3.5"></i> <span class="text-[9px] font-black uppercase truncate">${b.name}</span>`;
                content.appendChild(btn);
            });
            lucide.createIcons();
            panel.classList.remove('hidden');
            currentSection = section;
        }

        function addBlock(base, context) {
            const instanceId = 'id_' + Math.random().toString(36).substr(2, 9);
            activeBlocks.push({ ...base, instanceId, context, values: [...base.def], parentId: 'none' });
            render();
        }

        function moveBlock(currentIndex, direction) {
            const block = activeBlocks[currentIndex];
            if (block.parentId !== 'none') {
                const siblings = activeBlocks.filter(b => b.parentId === block.parentId);
                const localIdx = siblings.indexOf(block);
                const targetLocalIdx = localIdx + direction;
                if (targetLocalIdx < 0 || targetLocalIdx >= siblings.length) return;

                const targetSibling = siblings[targetLocalIdx];
                const targetGlobalIdx = activeBlocks.indexOf(targetSibling);
                [activeBlocks[currentIndex], activeBlocks[targetGlobalIdx]] = [activeBlocks[targetGlobalIdx], activeBlocks[currentIndex]];
                render();
                return;
            }

            const getBlockGroup = (parentId) => {
                const group = [activeBlocks.find(b => b.instanceId === parentId)];
                activeBlocks.forEach(b => { if(b.parentId === parentId) group.push(b); });
                return group;
            };

            const rootBlocks = activeBlocks.filter(b => b.parentId === 'none');
            const rootIdx = rootBlocks.findIndex(b => b.instanceId === block.instanceId);
            const targetRootIdx = rootIdx + direction;

            if (targetRootIdx < 0 || targetRootIdx >= rootBlocks.length) return;

            let newOrder = [];
            rootBlocks.forEach((rb, idx) => {
                if (idx === rootIdx) return;
                if (idx === targetRootIdx && direction === -1) {
                    newOrder.push(...getBlockGroup(block.instanceId));
                }
                newOrder.push(...getBlockGroup(rb.instanceId));
                if (idx === targetRootIdx && direction === 1) {
                    newOrder.push(...getBlockGroup(block.instanceId));
                }
            });

            activeBlocks = newOrder;
            render();
        }

        function removeBlock(id) { 
            activeBlocks = activeBlocks.filter(b => b.instanceId !== id && b.parentId !== id); 
            render(); 
        }

        function updateParent(id, newParentId) {
            const block = activeBlocks.find(b => b.instanceId === id);
            if (!block) return;
            block.parentId = newParentId;
            if (newParentId !== 'none') {
                activeBlocks = activeBlocks.filter(b => b.instanceId !== id);
                const lastIdx = activeBlocks.map((b, i) => (b.instanceId === newParentId || b.parentId === newParentId) ? i : -1).reduce((a, b) => Math.max(a, b), -1);
                activeBlocks.splice(lastIdx + 1, 0, block);
            }
            render();
        }

        // Función corregida para actualizar el estado real del bloque
        function updateParamValue(instanceId, paramIndex, newValue) {
            const block = activeBlocks.find(b => b.instanceId === instanceId);
            if (block) {
                block.values[paramIndex] = newValue;
                // No renderizamos aquí para no perder el foco si es input, 
                // pero sí para los select para confirmar el cambio visual.
                const bDef = blocksDef.find(d => d.id === block.id);
                if (['Tipo', 'Modo', 'Región', 'Op'].includes(bDef.params[paramIndex])) {
                    render();
                }
            }
        }

        function render() {
            const ws = document.getElementById('workspace');
            const emptyState = document.getElementById('empty-state');
            if (activeBlocks.length === 0) { ws.innerHTML = ''; emptyState.classList.remove('hidden'); return; }
            emptyState.classList.add('hidden');

            const btnBlocks = activeBlocks.filter(b => b.id === 'menu_btn');
            const btnOptionsHtml = `<option value="none">-- Libre --</option>` + 
                btnBlocks.map(btn => `<option value="${btn.instanceId}">Botón: ${btn.values[0]}</option>`).join('');

            let html = '';
            activeBlocks.forEach((b, i) => {
                if (b.parentId !== 'none') return;

                const isBtn = b.id === 'menu_btn';
                const isCollapsed = collapsedStates[b.instanceId];
                const children = activeBlocks.filter(c => c.parentId === b.instanceId);
                const paramsHtml = b.params.map((p, pi) => renderParam(b, p, pi, false)).join('');

                let childrenHtml = '';
                if (!isCollapsed) {
                    childrenHtml = children.map(child => {
                        const globalIdx = activeBlocks.indexOf(child);
                        return `
                        <div class="menu-child">
                            <div class="${child.color} rounded-lg shadow border-l-4 border-black/20 p-2">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-[8px] font-black uppercase text-white/80 flex items-center gap-1"><i data-lucide="${child.icon}" class="w-3 h-3"></i> ${child.name}</span>
                                    <div class="flex gap-1">
                                        <button onclick="moveBlock(${globalIdx},-1)" class="p-1"><i data-lucide="chevron-up" class="w-3 h-3 text-white/50"></i></button>
                                        <button onclick="moveBlock(${globalIdx},1)" class="p-1"><i data-lucide="chevron-down" class="w-3 h-3 text-white/50"></i></button>
                                        <button onclick="removeBlock('${child.instanceId}')" class="p-1 text-rose-300"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-1.5">${child.params.map((p, pi) => renderParam(child, p, pi, true)).join('')}</div>
                            </div>
                        </div>`;
                    }).join('');
                }

                html += `
                <div class="group-container">
                    <div class="${b.color} rounded-xl shadow-xl border-l-4 border-black/30 overflow-hidden mb-2">
                        <div class="flex items-center p-3 border-b border-black/10">
                            <div class="flex items-center gap-2 flex-1">
                                <i data-lucide="${b.icon}" class="w-4 h-4 text-white"></i>
                                <span class="text-[10px] font-black uppercase text-white">${b.name}</span>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="moveBlock(${i},-1)" class="p-1.5 bg-black/20 rounded-md hover:bg-black/40 text-white"><i data-lucide="chevron-up" class="w-3 h-3"></i></button>
                                <button onclick="moveBlock(${i},1)" class="p-1.5 bg-black/20 rounded-md hover:bg-black/40 text-white"><i data-lucide="chevron-down" class="w-3 h-3"></i></button>
                                <button onclick="removeBlock('${b.instanceId}')" class="p-1.5 bg-rose-900/40 rounded-md ml-1 hover:bg-rose-800/60 text-white"><i data-lucide="trash" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                        <div class="p-3 bg-black/10">
                            <div class="flex flex-wrap gap-2">${paramsHtml}</div>
                            ${isBtn ? `
                            <div class="mt-3 flex justify-between items-center">
                                <button onclick="collapsedStates['${b.instanceId}'] = !collapsedStates['${b.instanceId}']; render();" class="bg-indigo-900/60 px-3 py-1.5 rounded-lg text-[9px] font-black text-white flex gap-2">
                                    ${children.length} ACCIONES <i data-lucide="chevron-down" class="w-3 h-3 ${isCollapsed ? '' : 'rotate-icon'}"></i>
                                </button>
                            </div>` : ''}
                            ${(b.context === TYPES.MENU_ACT) ? `
                            <div class="mt-3">
                                <select onchange="updateParent('${b.instanceId}', this.value)" class="w-full bg-black/40 text-[9px] font-black rounded-lg px-2 py-2 border border-white/10 text-indigo-300 outline-none">
                                    ${btnOptionsHtml.replace(`value="${b.parentId}"`, `value="${b.parentId}" selected`)}
                                </select>
                            </div>` : ''}
                        </div>
                    </div>
                    <div class="${isCollapsed ? 'hidden' : ''} mb-4">${childrenHtml}</div>
                </div>`;
            });
            ws.innerHTML = html;
            lucide.createIcons();
        }

        function renderParam(b, p, pi, isMini) {
            const val = b.values[pi];
            const size = isMini ? "text-[10px] px-2 py-1" : "text-[11px] px-3 py-2";
            const label = isMini ? "text-[7px]" : "text-[8px]";
            
            let input = '';
            if (['Tipo', 'Modo', 'Región', 'Op'].includes(p)) {
                const options = p === 'Tipo' ? GG_TYPES : p === 'Modo' ? PROMPT_MODES : p === 'Región' ? GG_REGIONS : GG_OPS;
                input = `<select onchange="updateParamValue('${b.instanceId}', ${pi}, this.value)" class="bg-black/40 border border-white/5 rounded-lg ${size} outline-none text-white w-full">
                    ${options.map(o => `<option value="${o.v}" ${val === o.v ? 'selected' : ''}>${o.n}</option>`).join('')}
                </select>`;
            } else {
                input = `<input type="text" value="${val}" oninput="updateParamValue('${b.instanceId}', ${pi}, this.value)" class="bg-black/40 border border-white/5 rounded-lg ${size} outline-none text-white w-full">`;
            }
            return `<div class="flex flex-col flex-1 min-w-[80px]"><label class="${label} font-black uppercase opacity-60 text-white mb-0.5">${p}</label>${input}</div>`;
        }

        function generateLua() {
            const menuMain = activeBlocks.find(b => b.id === 'menu_main');
            const btns = activeBlocks.filter(b => b.id === 'menu_btn');
            if (!menuMain || btns.length === 0) { alert("Configura el Menú y al menos un Botón"); return; }

            let lua = `gg.setVisible(false)\nwhile true do\nif gg.isVisible(true) then gg.setVisible(false) end\n`;
            lua += `local opt = {${btns.map(b => `'${b.values[0]}'`).join(',')},'Ocultar','Salir'}\n`;
            lua += `local sel = gg.choice(opt,nil,'${menuMain.values[0]}')\n`;
            
            btns.forEach((btn, idx) => {
                lua += `${idx === 0 ? 'if' : 'elseif'} sel == ${idx + 1} then\n`;
                const acts = activeBlocks.filter(b => b.parentId === btn.instanceId);
                let inOff = false;
                let addr = "v.address";

                acts.forEach(c => {
                    if (c.id === 'off_base') {
                        lua += `local res = gg.getResults(gg.getResultCount())\nlocal eL, lL = {}, {}\nfor i, v in ipairs(res) do\n`;
                        inOff = true; addr = "v.address";
                    } else if (c.id === 'off_load' && inOff) {
                        addr = `(${addr}) ${c.values[0]} ${c.values[1].includes('0x') ? c.values[1] : '0x'+c.values[1]}`;
                        lua += `table.insert(lL,{address=${addr},flags=${c.values[2]}})\n`;
                    } else if (c.id === 'off_edit' && inOff) {
                        const cur = `(${addr}) ${c.values[0]} ${c.values[1].includes('0x') ? c.values[1] : '0x'+c.values[1]}`;
                        lua += `table.insert(eL,{address=${cur},flags=${c.values[3]},value=${c.values[2]}})\n`;
                    } else {
                        if (inOff) { lua += `end\ngg.setValues(eL)\ngg.loadResults(lL)\n`; inOff = false; }
                        lua += getCode(c) + "\n";
                    }
                });
                if (inOff) lua += `end\ngg.setValues(eL)\ngg.loadResults(lL)\n`;
            });
            lua += `elseif sel == ${btns.length + 1} then gg.setVisible(false)\nwhile not gg.isVisible(true) do gg.sleep(100) end\nelseif sel == ${btns.length + 2} then os.exit() end\nend`;
            document.getElementById('code-box').innerText = lua;
            document.getElementById('modal').style.display = 'flex';
        }

        function getCode(b) {
            switch(b.id) {
                case 'search': return `gg.clearResults()\ngg.searchNumber('${b.values[0]}',${b.values[1]})`;
                case 'edit': return `gg.getResults(100)\ngg.editAll('${b.values[0]}',${b.values[1]})`;
                case 'refine': return `gg.refineNumber('${b.values[0]}',${b.values[1]})`;
                case 'limit': return `gg.loadResults(gg.getResults(${b.values[0]}))`;
                case 'region': return `gg.setRanges(${b.values[0]})`;
                case 'clear': return `gg.clearResults()`;
                case 'sleep': return `gg.sleep(${b.values[0]})`;
                case 'alert': return `gg.alert('${b.values[0]}')`;
                case 'toast': return `gg.toast('${b.values[0]}')`;
                case 'pause': return `gg.processPause()`;
                case 'resume': return `gg.processResume()`;
                case 'dual_prompt':
                    return `local p = gg.prompt({'${b.values[0]}'},nil,{'number'})\nif p then\n${b.values[1] === 'SEARCH' ? 'gg.clearResults()\ngg.searchNumber(p[1],'+b.values[2]+')' : 'gg.editAll(p[1],'+b.values[2]+')'}\nend`;
                default: return "";
            }
        }

        function exportBackup() {
            const data = JSON.stringify({activeBlocks, collapsedStates});
            const blob = new Blob([data], {type: 'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Copia_de_seguridad_V1.txt'; a.click();
        }

        function importBackup(e) {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = (ev) => {
                const d = JSON.parse(ev.target.result);
                activeBlocks = d.activeBlocks; collapsedStates = d.collapsedStates || {};
                render();
            }; r.readAsText(f);
        }

        function copyCode() {
            const t = document.createElement('textarea'); t.value = document.getElementById('code-box').innerText; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
            showToast("Copiado");
        }
        function downloadLua() {
            const b = new Blob([document.getElementById('code-box').innerText], {type:'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download='Script.lua'; a.click();
        }
        function clearAll() { if(confirm("Borrar todo?")) { activeBlocks = []; render(); } }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function showToast(m) {
            const t = document.createElement('div'); t.className = "toast-animate fixed top-8 left-1/2 -translate-x-1/2 bg-indigo-600 text-white px-6 py-2 rounded-full z-[100] text-[10px] font-black";
            t.innerText = m; document.body.appendChild(t); setTimeout(()=>t.remove(), 2000);
        }

        window.onload = () => { render(); lucide.createIcons(); };
    </script>
</body>
</html>

