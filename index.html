<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- Configuración PWA para móviles -->
    <meta name="theme-color" content="#4f46e5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Mis Notas">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/564/564445.png">
    
    <title>Gestor de Notas Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .note-card { transition: transform 0.2s; }
        .note-card:active { transform: scale(0.98); }
        /* Animación suave para el borrado */
        .deleting { opacity: 0; transform: translateX(50px); transition: 0.3s; }
    </style>
</head>
<body class="min-h-screen pb-24">

    <!-- Encabezado Móvil -->
    <header class="bg-white border-b sticky top-0 z-30 px-4 py-3 shadow-sm">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <h1 class="text-lg font-bold text-slate-800 flex items-center gap-2">
                <i class="fas fa-sticky-note text-indigo-600"></i>
                Notas
            </h1>
            <div class="flex items-center gap-2">
                <!-- Botón de instalación visual -->
                <button id="pwaInstallBtn" class="hidden bg-indigo-100 text-indigo-700 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-tighter">
                    Instalar App
                </button>
                <button id="addBtnTop" class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center shadow-lg">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
        </div>
        <!-- Buscador -->
        <div class="max-w-4xl mx-auto mt-3">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="Buscar notas..." class="w-full pl-10 pr-4 py-2 bg-slate-100 border-none rounded-xl focus:ring-2 focus:ring-indigo-500 text-sm">
                <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4">
        <div id="notesContainer" class="space-y-3"></div>
        <div id="emptyState" class="hidden text-center py-20 opacity-40">
            <i class="fas fa-feather-alt text-5xl mb-4"></i>
            <p>No hay nada escrito aún</p>
        </div>
    </main>

    <!-- Modal Formulario -->
    <div id="noteModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-40 p-4 flex items-end sm:items-center justify-center">
        <div class="bg-white rounded-t-3xl sm:rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl">
            <div class="p-5 border-b flex justify-between items-center">
                <h2 id="modalTitle" class="font-bold">Nueva Nota</h2>
                <button id="closeModal" class="text-slate-400 p-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-5 space-y-4">
                <input type="text" id="noteKeyword" placeholder="Palabra clave (ej. Trabajo)" class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 border-slate-200">
                <textarea id="noteText" rows="6" placeholder="Escribe tu contenido aquí..." class="w-full px-4 py-3 border rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 border-slate-200 resize-none"></textarea>
            </div>
            <div class="p-5 bg-slate-50 flex gap-3">
                <button id="saveBtn" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg active:bg-indigo-700">Guardar Nota</button>
            </div>
        </div>
    </div>

    <!-- Modal Confirmar Borrado -->
    <div id="confirmModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-50 p-6 flex items-center justify-center">
        <div class="bg-white rounded-2xl w-full max-w-xs p-6 shadow-2xl text-center">
            <div class="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-trash"></i>
            </div>
            <h3 class="font-bold text-slate-800">¿Eliminar esta nota?</h3>
            <p class="text-xs text-slate-500 mt-1 mb-6">Esta acción no se puede deshacer.</p>
            <div class="flex gap-2">
                <button id="cancelDel" class="flex-1 py-2 bg-slate-100 rounded-lg text-slate-600 font-bold text-sm">No</button>
                <button id="confirmDel" class="flex-1 py-2 bg-red-600 rounded-lg text-white font-bold text-sm">Eliminar</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full text-sm shadow-xl opacity-0 transition-opacity pointer-events-none z-50"></div>

    <script>
        // --- Generación de Manifest Dinámico ---
        const myManifest = {
            "name": "Guardador de Texto Pro",
            "short_name": "Notas",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#ffffff",
            "theme_color": "#4f46e5",
            "icons": [{ "src": "https://cdn-icons-png.flaticon.com/512/564/564445.png", "sizes": "512x512", "type": "image/png" }]
        };
        const blob = new Blob([JSON.stringify(myManifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);

        // --- Lógica App ---
        let notes = JSON.parse(localStorage.getItem('notes_mobile_pwa')) || [];
        let editingId = null;
        let pendingId = null;

        const container = document.getElementById('notesContainer');
        const searchInput = document.getElementById('searchInput');

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 2000);
        }

        function render() {
            const q = searchInput.value.toLowerCase();
            const filtered = notes.filter(n => n.text.toLowerCase().includes(q) || n.keyword.toLowerCase().includes(q));
            
            container.innerHTML = '';
            document.getElementById('emptyState').classList.toggle('hidden', filtered.length > 0);

            filtered.sort((a,b) => b.date - a.date).forEach(n => {
                const card = document.createElement('div');
                card.id = `note-${n.id}`;
                card.className = "note-card bg-white p-4 rounded-2xl border border-slate-200 shadow-sm";
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="bg-indigo-50 text-indigo-600 text-[10px] font-bold px-2 py-0.5 rounded-lg uppercase">${n.keyword}</span>
                        <span class="text-[10px] text-slate-400">${new Date(n.date).toLocaleDateString()}</span>
                    </div>
                    <p class="text-slate-700 text-sm mb-4 whitespace-pre-wrap">${n.text}</p>
                    <div class="flex justify-end gap-3 border-t pt-3">
                        <button class="copy-btn text-slate-400 p-2"><i class="fas fa-copy"></i></button>
                        <button class="edit-btn text-slate-400 p-2"><i class="fas fa-edit"></i></button>
                        <button class="del-btn text-red-300 p-2"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                
                card.querySelector('.copy-btn').onclick = () => {
                    const el = document.createElement('textarea');
                    el.value = n.text; document.body.appendChild(el);
                    el.select(); document.execCommand('copy');
                    document.body.removeChild(el); showToast("Copiado");
                };
                card.querySelector('.edit-btn').onclick = () => openModal(n.id);
                card.querySelector('.del-btn').onclick = () => { pendingId = n.id; document.getElementById('confirmModal').classList.remove('hidden'); };
                
                container.appendChild(card);
            });
        }

        function openModal(id = null) {
            editingId = id;
            if(id) {
                const n = notes.find(x => x.id === id);
                document.getElementById('noteKeyword').value = n.keyword;
                document.getElementById('noteText').value = n.text;
                document.getElementById('modalTitle').innerText = "Editar Nota";
            } else {
                document.getElementById('noteKeyword').value = "";
                document.getElementById('noteText').value = "";
                document.getElementById('modalTitle').innerText = "Nueva Nota";
            }
            document.getElementById('noteModal').classList.remove('hidden');
        }

        document.getElementById('saveBtn').onclick = () => {
            const k = document.getElementById('noteKeyword').value || "General";
            const t = document.getElementById('noteText').value;
            if(!t) return;

            if(editingId) {
                const i = notes.findIndex(x => x.id === editingId);
                notes[i] = { ...notes[i], keyword: k, text: t, date: Date.now() };
            } else {
                notes.push({ id: Date.now(), keyword: k, text: t, date: Date.now() });
            }
            localStorage.setItem('notes_mobile_pwa', JSON.stringify(notes));
            document.getElementById('noteModal').classList.add('hidden');
            render();
            showToast("Guardado");
        };

        document.getElementById('confirmDel').onclick = () => {
            const card = document.getElementById(`note-${pendingId}`);
            card.classList.add('deleting');
            setTimeout(() => {
                notes = notes.filter(x => x.id !== pendingId);
                localStorage.setItem('notes_mobile_pwa', JSON.stringify(notes));
                document.getElementById('confirmModal').classList.add('hidden');
                render();
                showToast("Eliminado");
            }, 300);
        };

        document.getElementById('cancelDel').onclick = () => document.getElementById('confirmModal').classList.add('hidden');
        document.getElementById('addBtnTop').onclick = () => openModal();
        document.getElementById('closeModal').onclick = () => document.getElementById('noteModal').classList.add('hidden');
        searchInput.oninput = render;

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('pwaInstallBtn').classList.remove('hidden');
        });

        document.getElementById('pwaInstallBtn').onclick = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') document.getElementById('pwaInstallBtn').classList.add('hidden');
                deferredPrompt = null;
            }
        };

        render();
    </script>
</body>
</html>

