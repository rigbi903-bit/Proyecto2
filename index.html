<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GG Master Builder - Pro Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .menu-child { 
            margin-left: 1rem; 
            border-left: 2px dashed #334155; 
            padding-left: 0.75rem; 
            position: relative; 
            margin-top: 0.5rem; 
            margin-bottom: 0.5rem; 
        }
        .menu-child::before { 
            content: ""; 
            position: absolute; 
            left: 0; 
            top: 1.2rem; 
            width: 0.6rem; 
            border-top: 2px dashed #334155; 
        }
        
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        
        .collapsed { display: none !important; }
        .rotate-icon { transform: rotate(180deg); }

        .toolbox-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        @keyframes toast {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        .toast-animate { animation: toast 0.3s ease-out forwards; }
        .hidden-input { display: none; }
    </style>
</head>
<body class="text-slate-200 h-screen flex flex-col overflow-hidden">

    <input type="file" id="backup-input" class="hidden-input" accept=".txt" onchange="importBackup(event)">

    <header class="h-16 px-4 bg-slate-900 border-b border-slate-800 flex justify-between items-center shrink-0 z-40 shadow-xl">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 p-1.5 rounded-lg shadow-lg">
                <i data-lucide="shield-check" class="w-4 h-4 text-white"></i>
            </div>
            <div>
                <h1 class="text-[10px] font-black tracking-tighter uppercase italic leading-none text-white">GG BUILDER <span class="text-indigo-400">V9.5</span></h1>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="exportBackup()" title="Exportar Backup" class="p-2 bg-slate-800 rounded-lg text-emerald-400 hover:bg-emerald-500/10 transition-colors">
                <i data-lucide="save" class="w-4 h-4"></i>
            </button>
            <button onclick="document.getElementById('backup-input').click()" title="Importar Backup" class="p-2 bg-slate-800 rounded-lg text-amber-400 hover:bg-amber-500/10 transition-colors">
                <i data-lucide="folder-up" class="w-4 h-4"></i>
            </button>
            <button onclick="clearAll()" class="p-2 bg-slate-800 rounded-lg text-slate-400 hover:text-rose-400 transition-colors">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
            </button>
            <button onclick="generateLua()" class="flex items-center gap-1.5 px-3 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-[10px] font-black shadow-lg transition-transform active:scale-95 text-white">
                <i data-lucide="code-2" class="w-3 h-3 text-white"></i> GENERAR LUA
            </button>
        </div>
    </header>

    <nav class="bg-slate-900/50 border-b border-slate-800 p-2 overflow-x-auto flex gap-2 shrink-0 no-scrollbar">
        <button onclick="toggleSection('struct')" class="shrink-0 px-3 py-1.5 rounded-full bg-indigo-500/10 border border-indigo-500/30 text-indigo-400 text-[9px] font-bold uppercase">Estructura</button>
        <button onclick="toggleSection('memory')" class="shrink-0 px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/30 text-emerald-400 text-[9px] font-bold uppercase">Memoria</button>
        <button onclick="toggleSection('offset')" class="shrink-0 px-3 py-1.5 rounded-full bg-pink-500/10 border border-pink-500/30 text-pink-400 text-[9px] font-bold uppercase">Offsets</button>
        <button onclick="toggleSection('control')" class="shrink-0 px-3 py-1.5 rounded-full bg-orange-500/10 border border-orange-500/30 text-orange-400 text-[9px] font-bold uppercase">Control</button>
    </nav>

    <div id="toolbox-panel" class="bg-slate-900 border-b border-slate-800 hidden max-h-[45vh] overflow-y-auto p-4 z-30 shadow-2xl">
        <div id="toolbox-content" class="toolbox-grid"></div>
    </div>

    <main class="flex-1 bg-[#020617] p-4 overflow-y-auto relative">
        <div id="workspace" class="max-w-full mx-auto space-y-3 pb-24"></div>
        <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none opacity-20 text-center px-6">
            <i data-lucide="terminal" class="w-16 h-16 mb-4 text-indigo-500"></i>
            <p class="text-xs font-black uppercase tracking-widest text-white">Arrastra o añade elementos</p>
        </div>
    </main>

    <div id="modal" class="fixed inset-0 bg-black/95 backdrop-blur-md hidden flex-col z-50">
        <div class="flex justify-between items-center p-4 border-b border-slate-800 bg-slate-900">
            <span class="text-[10px] font-black text-indigo-400 tracking-widest uppercase italic">SCRIPT LUA</span>
            <button onclick="closeModal()" class="text-slate-400"><i data-lucide="x" class="w-6 h-6"></i></button>
        </div>
        <div class="flex-1 overflow-auto p-4 bg-black">
            <pre id="code-box" class="text-[10px] text-indigo-300 mono whitespace-pre-wrap"></pre>
        </div>
        <div class="p-4 bg-slate-900 flex gap-2">
            <button onclick="copyCode()" class="flex-1 bg-slate-800 py-4 rounded-xl text-[10px] font-black flex items-center justify-center gap-2 text-white hover:bg-slate-700 transition-colors">
                <i data-lucide="copy" class="w-4 h-4"></i> COPIAR
            </button>
            <button onclick="downloadLua()" class="flex-1 bg-indigo-600 py-4 rounded-xl text-[10px] font-black flex items-center justify-center gap-2 text-white hover:bg-indigo-500 transition-colors">
                <i data-lucide="download" class="w-4 h-4"></i> DESCARGAR
            </button>
        </div>
    </div>

    <script>
        const TYPES = { STRUCT: 'S', OFFSET_MOD: 'O', MENU_ACT: 'M' };
        
        const GG_TYPES = [
            { n: 'Dword', v: 'gg.TYPE_DWORD' }, { n: 'Float', v: 'gg.TYPE_FLOAT' },
            { n: 'Double', v: 'gg.TYPE_DOUBLE' }, { n: 'Word', v: 'gg.TYPE_WORD' },
            { n: 'Byte', v: 'gg.TYPE_BYTE' }, { n: 'Qword', v: 'gg.TYPE_QWORD' },
            { n: 'Xor', v: 'gg.TYPE_XOR' }
        ];

        const PROMPT_MODES = [{ n: 'Busqueda', v: 'SEARCH' }, { n: 'Editar resultados', v: 'EDIT' }];
        const GG_REGIONS = [{ n: 'Jh: Java heap', v: 'gg.REGION_JAVA_HEAP' }, { n: 'Ch: C++ heap', v: 'gg.REGION_C_HEAP' }, { n: 'Ca: C++ alloc', v: 'gg.REGION_C_ALLOC' }, { n: 'Cd: C++ data', v: 'gg.REGION_C_DATA' }, { n: 'Cb: C++ bss', v: 'gg.REGION_C_BSS' }, { n: 'A: Anonymous', v: 'gg.REGION_ANONYMOUS' }, { n: 'O: Other', v: 'gg.REGION_OTHER' }, { n: 'Xa: Code App', v: 'gg.REGION_CODE_APP' }, { n: 'S: Stack', v: 'gg.REGION_STACK' }];
        const GG_OPS = [{ n: '(+)', v: '+' }, { n: '(-)', v: '-' }];

        const blocksDef = [
            { id: 'menu_main', group: 'struct', type: TYPES.STRUCT, name: 'Menú Principal', color: 'bg-purple-600', icon: 'layout', params: ['Título'], def: ['MOD MENU'] },
            { id: 'menu_btn', group: 'struct', type: TYPES.STRUCT, name: 'Añadir Botón', color: 'bg-indigo-500', icon: 'square-plus', params: ['Nombre'], def: ['Función'] },
            { id: 'search', group: 'memory', name: 'Buscar', color: 'bg-blue-600', icon: 'search', params: ['Valor', 'Tipo'], def: ['0', 'gg.TYPE_DWORD'] },
            { id: 'edit', group: 'memory', name: 'Editar', color: 'bg-blue-500', icon: 'pencil', params: ['Valor', 'Tipo'], def: ['0', 'gg.TYPE_DWORD'] },
            { id: 'refine', group: 'memory', name: 'Refinar', color: 'bg-sky-500', icon: 'filter', params: ['Valor', 'Tipo'], def: ['0', 'gg.TYPE_DWORD'] },
            { id: 'limit', group: 'memory', name: 'Limitar', color: 'bg-cyan-600', icon: 'list-ordered', params: ['Cant'], def: ['0'] },
            { id: 'region', group: 'memory', name: 'Rango Memoria', color: 'bg-teal-600', icon: 'database', params: ['Región'], def: ['gg.REGION_OTHER'] },
            { id: 'clear', group: 'memory', name: 'Limpiar', color: 'bg-rose-600', icon: 'eraser', params: [], def: [] },
            
            { id: 'off_base', group: 'offset', type: TYPES.OFFSET_MOD, name: 'Base Offset', color: 'bg-pink-600', icon: 'anchor', params: [], def: [] },
            { id: 'off_load', group: 'offset', type: TYPES.OFFSET_MOD, name: 'Cargar Offset', color: 'bg-emerald-600', icon: 'list-plus', params: ['Op', 'Hex', 'Tipo'], def: ['+', '0', 'gg.TYPE_DWORD'] },
            { id: 'off_edit', group: 'offset', type: TYPES.OFFSET_MOD, name: 'Editar Offset', color: 'bg-rose-600', icon: 'pencil-line', params: ['Op', 'Hex', 'Valor', 'Tipo'], def: ['+', '0', '0', 'gg.TYPE_DWORD'] },
            
            { id: 'dual_prompt', group: 'control', name: 'Prompt (Dual)', color: 'bg-fuchsia-600', icon: 'keyboard', params: ['Descripcion', 'Modo', 'Tipo'], def: ['Agrega un valor', 'SEARCH', 'gg.TYPE_DWORD'] },
            { id: 'sleep', group: 'control', name: 'Espera', color: 'bg-slate-500', icon: 'clock', params: ['ms'], def: ['500'] },
            { id: 'alert', group: 'control', name: 'Alerta', color: 'bg-yellow-600', icon: 'bell', params: ['Msg'], def: ['Hecho'] },
            { id: 'toast', group: 'control', name: 'Toast', color: 'bg-orange-500', icon: 'zap', params: ['Msg'], def: ['Hecho'] },
            { id: 'hide', group: 'control', name: 'Ocultar GG', color: 'bg-gray-600', icon: 'eye-off', params: [], def: [] },
            { id: 'pause', group: 'control', name: 'Pausar', color: 'bg-red-600', icon: 'pause', params: [], def: [] },
            { id: 'resume', group: 'control', name: 'Reanudar', color: 'bg-green-600', icon: 'play', params: [], def: [] }
        ];

        let activeBlocks = [];
        let collapsedStates = {};
        let currentSection = null;

        function toggleSection(section) {
            const panel = document.getElementById('toolbox-panel');
            const content = document.getElementById('toolbox-content');
            if (currentSection === section) { panel.classList.add('hidden'); currentSection = null; return; }
            content.innerHTML = '';
            blocksDef.filter(b => b.group === section).forEach(b => {
                const ctx = (b.type === TYPES.STRUCT) ? b.type : TYPES.MENU_ACT;
                content.appendChild(createToolBtn(b, ctx));
            });
            lucide.createIcons();
            panel.classList.remove('hidden');
            currentSection = section;
        }

        function createToolBtn(b, context) {
            const btn = document.createElement('button');
            btn.className = `${b.color} flex items-center gap-2 p-3 rounded-xl text-left border-b-2 border-black/30 shadow-md transition-all active:scale-95`;
            btn.onclick = () => { addBlock(b, context); document.getElementById('toolbox-panel').classList.add('hidden'); currentSection = null; };
            btn.innerHTML = `<i data-lucide="${b.icon}" class="w-3.5 h-3.5 text-white"></i> <span class="text-[9px] font-black uppercase text-white truncate">${b.name}</span>`;
            return btn;
        }

        function addBlock(base, context) {
            const instanceId = 'id_' + Math.random().toString(36).substr(2, 9);
            activeBlocks.push({ ...base, instanceId, context, values: [...base.def], parentId: 'none' });
            render();
        }

        function toggleCollapse(id) { collapsedStates[id] = !collapsedStates[id]; render(); }

        function moveBlock(currentIndex, direction) {
            let nextIndex = currentIndex + direction;
            if (nextIndex < 0 || nextIndex >= activeBlocks.length) return;
            const [item] = activeBlocks.splice(currentIndex, 1);
            activeBlocks.splice(nextIndex, 0, item);
            render();
        }

        function removeBlock(id) { activeBlocks = activeBlocks.filter(b => b.instanceId !== id && b.parentId !== id); render(); }

        function updateParent(id, newParentId) {
            const block = activeBlocks.find(b => b.instanceId === id);
            if (!block) return;
            block.parentId = newParentId;
            if (newParentId !== 'none') {
                const index = activeBlocks.indexOf(block);
                activeBlocks.splice(index, 1);
                let lastIdx = activeBlocks.findIndex(b => b.instanceId === newParentId);
                for (let i = activeBlocks.length - 1; i >= 0; i--) {
                    if (activeBlocks[i].parentId === newParentId || activeBlocks[i].instanceId === newParentId) {
                        lastIdx = i; break;
                    }
                }
                activeBlocks.splice(lastIdx + 1, 0, block);
            }
            render();
        }

        function render() {
            const ws = document.getElementById('workspace');
            ws.innerHTML = '';
            const btnBlocks = activeBlocks.filter(b => b.id === 'menu_btn');
            document.getElementById('empty-state').classList.toggle('hidden', activeBlocks.length > 0);

            activeBlocks.forEach((b, i) => {
                if (b.parentId !== 'none' && b.context === TYPES.MENU_ACT) return; 
                const div = document.createElement('div');
                const isBtn = b.id === 'menu_btn';
                const isCollapsed = collapsedStates[b.instanceId];
                div.innerHTML = `
                    <div class="${b.color} rounded-xl shadow-lg flex flex-col border-l-4 border-black/30 mb-2 overflow-hidden">
                        <div class="flex items-center p-3 border-b border-black/10">
                            <div class="flex items-center gap-2 flex-1">
                                <i data-lucide="${b.icon}" class="w-4 h-4 text-white"></i>
                                <span class="text-[10px] font-black uppercase text-white truncate">${b.name}</span>
                            </div>
                            <div class="flex gap-1">
                                <button onclick="moveBlock(${i},-1)" class="p-1.5 bg-black/20 rounded-md"><i data-lucide="chevron-up" class="w-3 h-3 text-white"></i></button>
                                <button onclick="moveBlock(${i},1)" class="p-1.5 bg-black/20 rounded-md"><i data-lucide="chevron-down" class="w-3 h-3 text-white"></i></button>
                                <button onclick="removeBlock('${b.instanceId}')" class="p-1.5 bg-rose-900/40 rounded-md ml-1"><i data-lucide="trash" class="w-3 h-3 text-white"></i></button>
                            </div>
                        </div>
                        <div class="p-3 bg-black/10">
                            <div class="flex flex-wrap gap-2">
                                ${b.params.map((p, pi) => renderParam(b, p, pi)).join('')}
                            </div>
                            ${isBtn ? `
                            <div class="mt-3 flex justify-between items-center">
                                <span class="text-[7px] text-white/40 font-black uppercase tracking-widest italic">Contenedor</span>
                                <button onclick="toggleCollapse('${b.instanceId}')" class="bg-indigo-900/60 px-3 py-1.5 rounded-lg text-[9px] font-black text-white flex gap-2">
                                    ${activeBlocks.filter(x => x.parentId === b.instanceId).length} ACCIONES
                                    <i data-lucide="chevron-down" class="w-3 h-3 transition-transform ${isCollapsed ? '' : 'rotate-icon'}"></i>
                                </button>
                            </div>` : ''}
                            ${b.context === TYPES.MENU_ACT ? `
                            <div class="mt-3">
                                <select onchange="updateParent('${b.instanceId}', this.value)" class="w-full bg-black/40 text-[9px] font-black rounded-lg px-2 py-2 border border-white/10 text-indigo-300 outline-none">
                                    <option value="none">-- Libre --</option>
                                    ${btnBlocks.map(btn => `<option value="${btn.instanceId}" ${b.parentId===btn.instanceId?'selected':''}>Botón: ${btn.values[0]}</option>`).join('')}
                                </select>
                            </div>` : ''}
                        </div>
                    </div>
                    <div class="${isCollapsed ? 'collapsed' : ''} mb-4">${renderChildren(b.instanceId)}</div>
                `;
                ws.appendChild(div);
            });
            lucide.createIcons();
        }

        function renderChildren(parentId) {
            const children = activeBlocks.filter(b => b.parentId === parentId);
            return children.map(b => {
                const globalIdx = activeBlocks.indexOf(b);
                return `<div class="menu-child">
                    <div class="${b.color} rounded-lg shadow-md border-l-4 border-black/20 overflow-hidden">
                        <div class="flex items-center justify-between p-2 border-b border-black/5 bg-black/5">
                            <span class="text-[8px] font-black uppercase text-white/80 flex items-center gap-1"><i data-lucide="${b.icon}" class="w-3 h-3"></i> ${b.name}</span>
                            <div class="flex gap-1">
                                <button onclick="moveBlock(${globalIdx},-1)" class="p-1"><i data-lucide="chevron-up" class="w-3 h-3 text-white/50"></i></button>
                                <button onclick="moveBlock(${globalIdx},1)" class="p-1"><i data-lucide="chevron-down" class="w-3 h-3 text-white/50"></i></button>
                                <button onclick="removeBlock('${b.instanceId}')" class="p-1 text-rose-300"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                            </div>
                        </div>
                        <div class="p-2 flex flex-wrap gap-1.5">${b.params.map((p, pi) => renderParam(b, p, pi, true)).join('')}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderParam(b, p, pi, isMini = false) {
            const baseClass = isMini ? "text-[10px] px-2 py-1" : "text-[11px] px-3 py-2";
            const labelClass = isMini ? "text-[7px]" : "text-[8px]";
            if (p === 'Tipo') return createSelect(b, pi, p, GG_TYPES, isMini);
            if (p === 'Modo') return createSelect(b, pi, p, PROMPT_MODES, isMini);
            if (p === 'Región') return createSelect(b, pi, p, GG_REGIONS, isMini);
            if (p === 'Op') return createSelect(b, pi, p, GG_OPS, isMini);
            return `<div class="flex flex-col flex-1 min-w-[70px]">
                <label class="${labelClass} font-black uppercase opacity-60 ml-1 mb-0.5 text-white">${p}</label>
                <input type="text" value="${b.values[pi]}" oninput="updateValSilent('${b.instanceId}',${pi},this.value)" class="bg-black/40 border border-white/5 rounded-lg ${baseClass} outline-none text-white">
            </div>`;
        }

        function createSelect(b, pi, p, options, isMini) {
            const baseClass = isMini ? "text-[10px] px-2 py-1" : "text-[11px] px-3 py-2";
            return `<div class="flex flex-col flex-1 min-w-[70px]">
                <label class="${isMini?'text-[7px]':'text-[8px]'} font-black uppercase opacity-60 ml-1 mb-0.5 text-white">${p}</label>
                <select onchange="updateVal('${b.instanceId}',${pi},this.value)" class="bg-black/40 border border-white/5 rounded-lg ${baseClass} outline-none text-white">
                ${options.map(o => `<option value="${o.v}" ${b.values[pi] === o.v ? 'selected' : ''}>${o.n}</option>`).join('')}</select>
            </div>`;
        }

        function updateValSilent(id, pi, val) { const b = activeBlocks.find(x => x.instanceId === id); if(b) b.values[pi] = val; }
        function updateVal(id, pi, val) { updateValSilent(id, pi, val); render(); }

        function generateLua() {
            const menuMain = activeBlocks.find(b => b.id === 'menu_main');
            const btnBlocks = activeBlocks.filter(b => b.id === 'menu_btn');
            let lua = `gg.setVisible(false)\n`;
            
            if (menuMain && btnBlocks.length > 0) {
                lua += `while true do\nif gg.isVisible(true) then gg.setVisible(false) end\n`;
                lua += `local opciones = {${btnBlocks.map(b => `'${b.values[0]}'`).join(',')},'Ocultar','Salir'}\n`;
                lua += `local menu = gg.choice(opciones,nil,'${menuMain.values[0]}')\n`;
                
                btnBlocks.forEach((btn, idx) => {
                    lua += `${idx === 0 ? 'if' : 'elseif'} menu == ${idx + 1} then\n`;
                    const actions = activeBlocks.filter(b => b.parentId === btn.instanceId);
                    
                    let insideOffsetBlock = false;
                    let lastValidAddress = "v.address"; 

                    actions.forEach(c => {
                        const isLoad = c.id === 'off_load';
                        const isEdit = c.id === 'off_edit';
                        const isBase = c.id === 'off_base';

                        if (isBase) {
                            lua += `local count = gg.getResultCount()\nif count > 0 then\nlocal results = gg.getResults(count)\nlocal editList = {}\nlocal loadList = {}\nfor i, v in ipairs(results) do\n`;
                            insideOffsetBlock = true;
                            lastValidAddress = "v.address"; 
                        } else if (isLoad && insideOffsetBlock) {
                            const op = c.values[0] || '+';
                            const hex = (c.values[1] || '0').startsWith('0x') ? c.values[1] : '0x'+c.values[1];
                            const type = c.values[2] || 'gg.TYPE_DWORD';
                            lastValidAddress = `(${lastValidAddress}) ${op} ${hex}`;
                            lua += `table.insert(loadList,{address=${lastValidAddress},flags=${type}})\n`;
                        } else if (isEdit && insideOffsetBlock) {
                            const op = c.values[0] || '+';
                            const hex = (c.values[1] || '0').startsWith('0x') ? c.values[1] : '0x'+c.values[1];
                            const val = c.values[2] || '0';
                            const type = c.values[3] || 'gg.TYPE_DWORD';
                            const currentAddr = `(${lastValidAddress}) ${op} ${hex}`;
                            lua += `table.insert(editList,{address=${currentAddr},flags=${type},value=${val}})\n`;
                        } else {
                            if (insideOffsetBlock) { 
                                lua += `end\nif #editList > 0 then gg.setValues(editList) end\nif #loadList > 0 then gg.loadResults(loadList) end\nend\n`; 
                                insideOffsetBlock = false; 
                            }
                            lua += `${getCode(c)}\n`;
                        }
                    });
                    if (insideOffsetBlock) {
                        lua += `end\nif #editList > 0 then gg.setValues(editList) end\nif #loadList > 0 then gg.loadResults(loadList) end\nend\n`;
                    }
                });
                lua += `elseif menu == ${btnBlocks.length + 1} then\ngg.setVisible(false)\nwhile not gg.isVisible(true) do gg.sleep(100) end\nelseif menu == ${btnBlocks.length + 2} then os.exit() end\nend`;
            } else { lua = `gg.alert('Configura un menú y al menos un botón')`; }
            
            document.getElementById('code-box').innerText = lua;
            document.getElementById('modal').style.display = 'flex';
        }

        function getCode(b) {
            switch(b.id) {
                case 'search': return `gg.clearResults()\ngg.searchNumber('${b.values[0]}',${b.values[1]})`;
                case 'edit': return `gg.getResults(100)\ngg.editAll('${b.values[0]}',${b.values[1]})`;
                case 'refine': return `gg.refineNumber('${b.values[0]}',${b.values[1]})`;
                case 'limit': return `gg.loadResults(gg.getResults(${b.values[0]}))`;
                case 'region': return `gg.setRanges(${b.values[0]})`;
                case 'clear': return `gg.clearResults()`;
                case 'dual_prompt':
                    const isS = b.values[1] === 'SEARCH';
                    let c = `local p = gg.prompt({'${b.values[0]}'},nil,{'number'})\nif p ~= nil then\n`;
                    if (isS) { c += `gg.clearResults()\ngg.searchNumber(p[1],${b.values[2]})\nend`; } 
                    else { c += `gg.getResults(1000)\ngg.editAll(p[1],${b.values[2]})\nend`; }
                    return c;
                case 'sleep': return `gg.sleep(${b.values[0]})`;
                case 'alert': return `gg.alert('${b.values[0]}')`;
                case 'toast': return `gg.toast('${b.values[0]}')`;
                case 'hide': return `gg.setVisible(false)`;
                case 'pause': return `gg.processPause()`;
                case 'resume': return `gg.processResume()`;
                default: return ``;
            }
        }

        function exportBackup() {
            const json = JSON.stringify({activeBlocks, collapsedStates}, null, 2);
            const blob = new Blob([json], {type: 'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'backup_pro.txt'; a.click();
        }

        function importBackup(e) {
            const f = e.target.files[0]; if(!f) return;
            const r = new FileReader(); r.onload = (ev) => {
                try {
                    const d = JSON.parse(ev.target.result);
                    activeBlocks = d.activeBlocks || [];
                    collapsedStates = d.collapsedStates || {};
                    render();
                    showToast("Cargado correctamente");
                } catch(err) { showToast("Error al importar", "bg-rose-600"); }
            }; r.readAsText(f);
        }

        function copyCode() {
            const txt = document.getElementById('code-box').innerText;
            const el = document.createElement('textarea'); el.value = txt; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el);
            showToast("Código copiado al portapapeles");
        }

        function downloadLua() {
            const blob = new Blob([document.getElementById('code-box').innerText], {type: 'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'script.lua'; a.click();
        }

        function clearAll() { if(confirm("¿Seguro que quieres borrar todo?")) { activeBlocks = []; render(); } }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function showToast(m, color = "bg-indigo-600") {
            const t = document.createElement('div'); t.className = `toast-animate fixed top-8 left-1/2 -translate-x-1/2 ${color} text-white px-6 py-2 rounded-full z-[100] text-[10px] font-black shadow-xl`;
            t.innerText = m; document.body.appendChild(t); setTimeout(()=>t.remove(), 2000);
        }

        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>

